<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container p-4">
      <h4>Perfiles Facebook</h4>
      <div class="row mt-4" id="profilesContainer"></div>
    </div>
  </body>

  <script>
    var accessToken = null;
    var accessTokenDos = null;
    var igid = null;
    window.fbAsyncInit = function () {
      FB.init({
        appId: "254476297402875",
        xfbml: true,
        cookie: true,
        version: "v2.8",
      });

      FB.AppEvents.logPageView();

      FB.getLoginStatus(function (response) {
        if (response.status === "connected") {
          console.log(response.authResponse.accessToken);
          accessToken = response.authResponse.accessToken;
          const apiUrl =
            "https://graph.facebook.com/v17.0/me/accounts?access_token=" +
            response.authResponse.accessToken;

          fetch(apiUrl)
            .then((response) => response.json())
            .then((data) => {
              const profiles = data.data;
              profiles.forEach((profile) => {
                console.log(profile);
                const profilesContainer =
                  document.getElementById("profilesContainer");
                const column = document.createElement("div");
                column.classList.add("col-4", "mb-3");

                const card = document.createElement("div");
                card.classList.add("card");

                const cardBody = document.createElement("div");
                cardBody.classList.add("card-body");
                cardBody.setAttribute("id", profile.id);

                const title = document.createElement("h5");
                title.classList.add("card-title");
                title.textContent = profile.name;

                const id = document.createElement("p");
                id.classList.add("card-text");
                id.textContent = "ID: " + profile.id;

                cardBody.appendChild(title);
                cardBody.appendChild(id);
                card.appendChild(cardBody);
                column.appendChild(card);
                profilesContainer.appendChild(column);

                fetch(
                  "https://graph.facebook.com/v17.0/" +
                    profile.id +
                    "?fields=instagram_business_account&access_token=" +
                    accessToken
                )
                  .then((response) => response.json())
                  .then((data) => {
                    console.log(data);
                    const cardBody = document.getElementById(data.id);
                    if (data.instagram_business_account) {
                      const ig = document.createElement("p");
                      ig.classList.add("card-text");
                      ig.textContent =
                        "IG: " + data.instagram_business_account.id;
                      igid = data.instagram_business_account.id;
                      cardBody.appendChild(ig);

                      fetch(
                        "https://graph.facebook.com/v17.0/" +
                          data.id +
                          "?fields=access_token&access_token=" +
                          accessToken
                      )
                        .then((response) => response.json())
                        .then((data) => {
                          console.log(data);
                          accessTokenDos = data.access_token;
                          fetch(
                            "https://graph.facebook.com/v17.0/" +
                              data.id +
                              "/conversations?platform=instagram&access_token=" +
                              accessTokenDos
                          )
                            .then((response) => response.json())
                            .then((dataConversations) => {
                              console.log(dataConversations);
                              // dataConversations.data.forEach((single) => {
                              //   fetch(
                              //     "https://graph.facebook.com/v17.0/" +
                              //       single.id +
                              //       "?fields=messages&access_token=" +
                              //       data.access_token
                              //   )
                              //     .then((response) => response.json())
                              //     .then((dataMessages) => {
                              //       console.log(dataMessages);
                              //       dataMessages.messages.data.forEach(
                              //         (single) => {
                              //           fetch(
                              //             "https://graph.facebook.com/v17.0/" +
                              //               single.id +
                              //               "?fields=id,created_time,from,to,message&access_token=" +
                              //               data.access_token
                              //           )
                              //             .then((response) => response.json())
                              //             .then((dataSingleMessages) => {
                              //               console.log(dataSingleMessages);
                              //             });
                              //         }
                              //       );
                              //     });
                              // });
                            });
                        });
                    }
                  });
              });
            })
            .catch((error) => {
              debugger;
              console.error("Error al obtener perfiles:", error);
            });

          FB.api("/me", function (response) {
            // Se puede llamar a la api como https://graph.facebook.com/v17.0/me/accounts?access_token={access-token}
            console.log(JSON.stringify(response));
          });
        } else {
          FB.login(
            function (response) {
              console.log(response);
            },
            {
              config_id: "835834851276991", // configuration ID goes here
              response_type: "code", // must be set to 'code' for SUAT
            }
          );
        }
      });
    };

    (function (d, s, id) {
      var js,
        fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {
        return;
      }
      js = d.createElement(s);
      js.id = id;
      js.src = "https://connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    })(document, "script", "facebook-jssdk");

    function checkLoginState() {
      FB.getLoginStatus(function (response) {
        console.log(response);
      });
    }
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"
  ></script>
</html>
